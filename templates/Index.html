<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Shorts Automator Pro</title>
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
:root{
  --r:#ff2d55;--g:#30d158;--b:#0a84ff;--y:#ffd60a;
  --bg:#0c0c0e;--s1:#161618;--s2:#1c1c1f;--s3:#252528;
  --br:rgba(255,255,255,0.06);--t:#f2f2f7;--m:rgba(255,255,255,0.36);
}
*{margin:0;padding:0;box-sizing:border-box;}
body{background:var(--bg);font-family:'Outfit',sans-serif;color:var(--t);min-height:100vh;display:flex;}
aside{width:210px;min-width:210px;background:var(--s1);border-right:1px solid var(--br);display:flex;flex-direction:column;position:sticky;top:0;height:100vh;}
.logo{padding:18px 16px;border-bottom:1px solid var(--br);}
.logo-row{display:flex;align-items:center;gap:10px;}
.logo-icon{width:34px;height:34px;background:var(--r);border-radius:9px;display:flex;align-items:center;justify-content:center;font-size:18px;flex-shrink:0;}
.logo-name{font-size:15px;font-weight:700;}
.logo-tag{font-size:11px;color:var(--m);margin-top:1px;}
nav{flex:1;padding:10px 0;}
.ni{display:flex;align-items:center;gap:10px;padding:9px 14px;cursor:pointer;color:var(--m);font-size:14px;font-weight:500;border-left:2px solid transparent;transition:all .12s;user-select:none;}
.ni:hover{color:var(--t);background:rgba(255,255,255,0.03);}
.ni.on{color:var(--t);border-left-color:var(--r);background:rgba(255,45,85,0.07);}
.ni .ic{font-size:16px;width:20px;text-align:center;}
.aside-foot{padding:12px 14px;border-top:1px solid var(--br);}
.yt-badge{display:flex;align-items:center;gap:7px;font-size:12px;padding:7px 10px;border-radius:9px;margin-bottom:8px;}
.yt-badge.ok{background:rgba(48,209,88,.1);color:var(--g);}
.yt-badge.no{background:rgba(255,255,255,.05);color:var(--m);}
.sb{width:100%;padding:8px;border-radius:9px;border:none;font-family:inherit;font-size:12px;font-weight:600;cursor:pointer;}
.sb.conn{background:var(--b);color:#fff;}
.sb.disc{background:var(--s3);color:var(--m);}
main{flex:1;overflow-y:auto;}
.pn{display:none;padding:26px 28px;max-width:840px;}
.pn.on{display:block;}
.ph{margin-bottom:22px;}
.ph h1{font-size:21px;font-weight:700;margin-bottom:3px;}
.ph p{font-size:13px;color:var(--m);}
.card{background:var(--s1);border:1px solid var(--br);border-radius:14px;padding:18px;margin-bottom:12px;}
.ct{font-size:11px;font-weight:700;color:var(--m);text-transform:uppercase;letter-spacing:.06em;margin-bottom:12px;}
.fg{margin-bottom:11px;}
.fl{display:block;font-size:12px;color:var(--m);font-weight:600;margin-bottom:5px;}
input,textarea,select{width:100%;background:var(--s2);border:1px solid var(--br);border-radius:9px;padding:10px 13px;color:var(--t);font-family:inherit;font-size:14px;outline:none;transition:border-color .18s;}
input:focus,textarea:focus,select:focus{border-color:rgba(255,45,85,.45);}
input::placeholder,textarea::placeholder{color:var(--m);}
textarea{min-height:68px;resize:vertical;}
select option{background:var(--s2);}
.btn{border:none;border-radius:9px;padding:10px 16px;font-family:inherit;font-size:14px;font-weight:700;cursor:pointer;display:inline-flex;align-items:center;gap:7px;transition:all .13s;white-space:nowrap;}
.btn:hover:not(:disabled){opacity:.86;transform:translateY(-1px);}
.btn:disabled{opacity:.3;cursor:not-allowed;transform:none;}
.btn-r{background:var(--r);color:#fff;}
.btn-g{background:var(--g);color:#000;}
.btn-b{background:var(--b);color:#fff;}
.btn-gh{background:var(--s3);color:var(--t);border:1px solid var(--br);}
.btn-sm{padding:7px 12px;font-size:12px;border-radius:8px;}
.pcard{background:var(--s1);border:1px solid var(--br);border-radius:14px;padding:15px;margin-bottom:10px;}
.prow{display:flex;align-items:center;gap:8px;margin-bottom:8px;}
.spin{width:13px;height:13px;border:2px solid rgba(255,255,255,.1);border-top-color:var(--r);border-radius:50%;animation:sp .7s linear infinite;flex-shrink:0;}
@keyframes sp{to{transform:rotate(360deg);}}
.pst{font-size:13px;color:var(--m);flex:1;}
.bg{background:rgba(255,255,255,.06);border-radius:100px;height:4px;overflow:hidden;}
.bar{height:100%;background:linear-gradient(90deg,var(--r),#ff6b8a);border-radius:100px;transition:width .4s;width:0%;}
.bar.done{background:linear-gradient(90deg,var(--g),#00b248);}
.gbanner{background:rgba(255,214,10,.07);border:1px solid rgba(255,214,10,.2);border-radius:12px;padding:13px 16px;margin-bottom:14px;display:flex;gap:12px;align-items:flex-start;}
.tx{background:var(--s2);border:1px solid var(--br);border-radius:10px;padding:13px;max-height:160px;overflow-y:auto;font-size:12px;line-height:1.8;color:var(--m);font-family:'JetBrains Mono',monospace;}
.mgrid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:10px;margin-top:4px;}
.mc{background:var(--s2);border:1px solid var(--br);border-radius:11px;padding:13px;cursor:pointer;transition:border-color .13s;}
.mc:hover{border-color:rgba(255,45,85,.4);background:rgba(255,45,85,.04);}
.mc-time{font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--r);margin-bottom:5px;}
.mc-title{font-size:13px;font-weight:700;margin-bottom:3px;}
.mc-reason{font-size:11px;color:var(--m);line-height:1.5;margin-bottom:6px;}
.mc-hook{font-size:11px;color:var(--y);}
.cgrid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:10px;}
.cc{background:var(--s2);border:1px solid var(--br);border-radius:12px;overflow:hidden;}
.cthumb{height:120px;background:#000;display:flex;align-items:center;justify-content:center;}
.cthumb video{width:100%;height:120px;object-fit:cover;}
.ep{font-size:30px;color:var(--m);}
.cinfo{padding:11px;}
.ctime{font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--r);margin-bottom:3px;}
.ctitle{font-size:12px;font-weight:700;margin-bottom:2px;}
.creason{font-size:11px;color:var(--m);line-height:1.5;}
.cst{font-size:11px;color:var(--m);margin-top:5px;}
.cst.ok{color:var(--g);}
.cst.er{color:var(--r);}
.cact{display:flex;gap:6px;flex-wrap:wrap;margin-top:6px;}
.rlink{color:var(--g);font-size:11px;font-weight:700;text-decoration:none;display:inline-block;margin-top:5px;}
.se{text-align:center;padding:44px;color:var(--m);}
.sei{font-size:42px;margin-bottom:10px;}
table{width:100%;border-collapse:collapse;font-size:13px;}
th{text-align:left;padding:8px 12px;color:var(--m);font-size:11px;font-weight:700;text-transform:uppercase;border-bottom:1px solid var(--br);}
td{padding:11px 12px;border-bottom:1px solid rgba(255,255,255,.04);vertical-align:middle;}
tr:last-child td{border-bottom:none;}
.pill{display:inline-block;padding:3px 10px;border-radius:20px;font-size:11px;font-weight:700;}
.pill.pending{background:rgba(255,214,10,.14);color:var(--y);}
.pill.done{background:rgba(48,209,88,.14);color:var(--g);}
.pill.uploading{background:rgba(10,132,255,.14);color:var(--b);}
.ov{display:none;position:fixed;inset:0;background:rgba(0,0,0,.8);z-index:200;align-items:center;justify-content:center;}
.ov.on{display:flex;}
.modal{background:var(--s1);border:1px solid var(--br);border-radius:18px;padding:24px;width:92%;max-width:440px;max-height:90vh;overflow-y:auto;}
.modal h3{font-size:15px;font-weight:700;margin-bottom:16px;}
.mbtns{display:flex;gap:8px;margin-top:16px;flex-wrap:wrap;}
.flash{padding:10px 14px;border-radius:10px;font-size:13px;margin-bottom:14px;}
.flash.ok{background:rgba(48,209,88,.1);border:1px solid rgba(48,209,88,.25);color:var(--g);}
.flash.er{background:rgba(255,45,85,.1);border:1px solid rgba(255,45,85,.25);color:#ff6b8a;}
.step{display:flex;gap:12px;margin-bottom:14px;padding-bottom:14px;border-bottom:1px solid var(--br);}
.step:last-child{border-bottom:none;margin-bottom:0;padding-bottom:0;}
.snum{width:26px;height:26px;background:var(--r);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:700;flex-shrink:0;margin-top:2px;}
.sbody h4{font-size:13px;font-weight:700;margin-bottom:4px;}
.sbody p{font-size:12px;color:var(--m);line-height:1.8;}
.uri-box{background:var(--s2);border:1px solid var(--br);border-radius:9px;padding:10px 13px;margin-top:8px;display:flex;align-items:center;justify-content:space-between;gap:10px;}
.uri-code{font-family:'JetBrains Mono',monospace;font-size:12px;color:var(--r);word-break:break-all;}
.env-box{background:var(--s2);border-radius:8px;padding:12px 14px;margin-top:8px;font-family:'JetBrains Mono',monospace;font-size:12px;line-height:2.2;color:var(--m);}
.env-box span{color:var(--t);}
.status-dot{display:inline-block;width:8px;height:8px;border-radius:50%;margin-right:6px;}
.dot-g{background:var(--g);}
.dot-r{background:var(--r);}
.dot-y{background:var(--y);}
@media(max-width:600px){
  aside{width:52px;min-width:52px;}
  .logo-name,.logo-tag,.ni span,.ntxt{display:none;}
  .ni{justify-content:center;padding:11px;}
  .pn{padding:16px;}
  .mgrid,.cgrid{grid-template-columns:1fr 1fr;}
}
@media(max-width:420px){.mgrid,.cgrid{grid-template-columns:1fr;}}
</style>
</head>
<body>

<aside>
  <div class="logo">
    <div class="logo-row">
      <div class="logo-icon">‚ñ∂</div>
      <div><div class="logo-name">Shorts Pro</div><div class="logo-tag">AI Automator</div></div>
    </div>
  </div>
  <nav>
    <div class="ni on" onclick="go('analyze')" id="n-analyze"><span class="ic">üé¨</span><span class="ntxt">Analyze & Clip</span></div>
    <div class="ni" onclick="go('schedule')" id="n-schedule"><span class="ic">üóìÔ∏è</span><span class="ntxt">Schedule</span></div>
    <div class="ni" onclick="go('settings')" id="n-settings"><span class="ic">‚öôÔ∏è</span><span class="ntxt">Setup</span></div>
  </nav>
  <div class="aside-foot">
    <div class="yt-badge no" id="yt-badge"><span>‚ö†Ô∏è</span><span class="ntxt" id="yt-txt">Not connected</span></div>
    <button class="sb conn" id="yt-btn" onclick="ytAction()">Connect YouTube</button>
  </div>
</aside>

<main>

<!-- ANALYZE PANEL -->
<div class="pn on" id="p-analyze">
  <div class="ph">
    <h1>üé¨ Analyze & Multi-Clip</h1>
    <p>‡ßß‡¶ü‡¶æ ‡¶≠‡¶ø‡¶°‡¶ø‡¶ì ‚Üí Gemini best moments ‡¶¨‡ßá‡¶õ‡ßá ‡¶®‡ßá‡¶Ø‡¶º ‚Üí ‡¶Ø‡¶§‡¶ü‡¶æ ‡¶ö‡¶æ‡¶ì Shorts ‡¶¨‡¶æ‡¶®‡¶æ‡¶ì</p>
  </div>

  <div id="flash-area"></div>

  <div class="gbanner" id="gemini-banner">
    <span style="font-size:22px;">ü§ñ</span>
    <div style="flex:1;">
      <div style="font-size:13px;font-weight:700;margin-bottom:4px;">Gemini API Key ‡¶¶‡¶∞‡¶ï‡¶æ‡¶∞</div>
      <div style="font-size:12px;color:var(--m);margin-bottom:8px;">
        Transcript ‡¶ì best moments ‡¶è‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø‡•§ Free:
        <a href="https://aistudio.google.com/app/apikey" target="_blank" style="color:var(--b);">aistudio.google.com</a>
      </div>
      <div style="display:flex;gap:8px;">
        <input type="password" id="quick-gk" placeholder="AIza..." style="max-width:240px;margin:0;">
        <button class="btn btn-sm btn-b" onclick="saveGeminiKey()">Save</button>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="ct">YouTube Video</div>
    <div class="fg">
      <input type="text" id="vu" placeholder="https://youtube.com/watch?v=...">
    </div>
    <div style="display:flex;align-items:flex-end;gap:14px;flex-wrap:wrap;">
      <div class="fg" style="margin:0;">
        <label class="fl">‡¶ï‡¶§‡¶ü‡¶æ Shorts?</label>
        <div style="display:flex;align-items:center;gap:8px;">
          <button class="btn btn-gh btn-sm" onclick="adj(-1)">‚àí</button>
          <input type="number" id="nc" value="5" min="1" max="20" style="width:64px;text-align:center;flex:none;">
          <button class="btn btn-gh btn-sm" onclick="adj(1)">+</button>
        </div>
      </div>
      <button class="btn btn-r" id="abtn" onclick="doAnalyze()" style="margin-bottom:11px;">ü§ñ Analyze ‡¶ï‡¶∞‡ßã</button>
    </div>
  </div>

  <div id="aprog" style="display:none;">
    <div class="pcard">
      <div class="prow"><div class="spin"></div><span class="pst" id="ast">‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</span></div>
      <div class="bg"><div class="bar" id="abar"></div></div>
    </div>
  </div>

  <div id="tsx" style="display:none;">
    <div class="card">
      <div class="ct">üìÑ Transcript</div>
      <div class="tx" id="txtext"></div>
    </div>
  </div>

  <div id="msx" style="display:none;">
    <div class="card">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:5px;flex-wrap:wrap;gap:8px;">
        <div class="ct" style="margin:0;">üéØ Gemini ‚Äî Best Moments</div>
        <button class="btn btn-r btn-sm" id="gab" onclick="genAll()">‚ö° ‡¶∏‡¶¨ Generate ‡¶ï‡¶∞‡ßã</button>
      </div>
      <div style="font-size:12px;color:var(--m);margin-bottom:12px;">‡¶è‡¶ï‡¶ü‡¶æ‡¶Ø‡¶º ‡¶ï‡ßç‡¶≤‡¶ø‡¶ï ‚Üí ‡¶∂‡ßÅ‡¶ß‡ßÅ ‡¶∏‡ßá‡¶ü‡¶æ generate ‡¶π‡¶¨‡ßá</div>
      <div class="mgrid" id="mgrid"></div>
    </div>
  </div>

  <div id="csx" style="display:none;">
    <div class="card">
      <div class="ct">üìπ Generated Clips</div>
      <div class="cgrid" id="cgrid"></div>
    </div>
  </div>
</div>

<!-- SCHEDULE PANEL -->
<div class="pn" id="p-schedule">
  <div class="ph">
    <h1>üóìÔ∏è Scheduled Uploads</h1>
    <p>‡¶®‡¶ø‡¶∞‡ßç‡¶¶‡¶ø‡¶∑‡ßç‡¶ü ‡¶∏‡¶Æ‡¶Ø‡¶º‡ßá upload ‚Äî ‡¶Ü‡¶™‡¶≤‡ßã‡¶°‡ßá‡¶∞ ‡¶™‡¶∞ task ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶Ø‡¶æ‡¶¨‡ßá</p>
  </div>
  <div class="card" id="sc">
    <div class="se"><div class="sei">üóìÔ∏è</div><p>‡¶ï‡ßã‡¶®‡ßã scheduled upload ‡¶®‡ßá‡¶á</p></div>
  </div>
</div>

<!-- SETTINGS PANEL -->
<div class="pn" id="p-settings">
  <div class="ph">
    <h1>‚öôÔ∏è Setup Guide</h1>
    <p>Railway deploy + OAuth setup</p>
  </div>

  <div class="card">
    <div class="ct">ü§ñ Gemini API Key</div>
    <div class="fg">
      <label class="fl">‡¶™‡ßç‡¶∞‡¶§‡¶ø user ‡¶®‡¶ø‡¶ú‡ßá‡¶∞ key ‡¶¶‡ßá‡¶¨‡ßá ‚Äî browser ‡¶è save ‡¶•‡¶æ‡¶ï‡¶¨‡ßá, server ‡¶è store ‡¶π‡¶Ø‡¶º ‡¶®‡¶æ</label>
      <input type="password" id="sk" placeholder="AIza...">
    </div>
    <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
      <button class="btn btn-b btn-sm" onclick="saveGeminiKey()">üíæ Save Key</button>
      <span id="key-status" style="font-size:12px;color:var(--m);"></span>
    </div>
  </div>

  <div class="card">
    <div class="ct">üé• YouTube OAuth ‚Äî Railway Setup</div>

    <div class="step">
      <div class="snum">1</div>
      <div class="sbody">
        <h4>Google Cloud Console</h4>
        <p><a href="https://console.cloud.google.com/apis/credentials" target="_blank" style="color:var(--b);">console.cloud.google.com/apis/credentials</a>
        <br>‚Üí Create Credentials ‚Üí OAuth 2.0 Client ID</p>
      </div>
    </div>

    <div class="step">
      <div class="snum">2</div>
      <div class="sbody">
        <h4>Application Type</h4>
        <p><strong style="color:var(--t);">Web application</strong> ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡ßã‡•§<br>(Desktop app ‡¶π‡¶≤‡ßá Error 400 ‡¶Ü‡¶∏‡¶¨‡ßá!)</p>
      </div>
    </div>

    <div class="step">
      <div class="snum">3</div>
      <div class="sbody">
        <h4>Authorized Redirect URI ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßã</h4>
        <p>Railway deploy ‡¶π‡¶≤‡ßá ‡¶è‡¶á URI exact ‡¶ï‡¶™‡¶ø ‡¶ï‡¶∞‡ßá paste ‡¶ï‡¶∞‡ßã:</p>
        <div class="uri-box">
          <span class="uri-code" id="ruri">Deploy ‡¶π‡¶≤‡ßá ‡¶è‡¶ñ‡¶æ‡¶®‡ßá URI ‡¶¶‡ßá‡¶ñ‡¶æ‡¶¨‡ßá</span>
          <button class="btn btn-gh btn-sm" onclick="copyURI()">üìã Copy</button>
        </div>
      </div>
    </div>

    <div class="step">
      <div class="snum">4</div>
      <div class="sbody">
        <h4>Railway Environment Variables</h4>
        <p>Railway Dashboard ‚Üí Project ‚Üí Variables ‡¶è ‡¶¶‡¶æ‡¶ì:</p>
        <div class="env-box">
          YOUTUBE_CLIENT_ID = <span>your_client_id</span><br>
          YOUTUBE_CLIENT_SECRET = <span>your_secret</span><br>
          FLASK_SECRET_KEY = <span>any_random_string</span><br>
          GEMINI_API_KEY = <span>optional_default_key</span>
        </div>
      </div>
    </div>

    <div class="step">
      <div class="snum">5</div>
      <div class="sbody">
        <h4>Multi-user ‡¶π‡¶≤‡ßá</h4>
        <p>Google Console ‚Üí OAuth consent screen ‚Üí <strong style="color:var(--t);">"Publish App"</strong> ‡¶ï‡¶∞‡ßã‡•§<br>
        ‡¶®‡¶æ ‡¶π‡¶≤‡ßá Test Users ‡¶è ‡¶™‡ßç‡¶∞‡¶§‡¶ø user ‡¶è‡¶∞ Gmail add ‡¶ï‡¶∞‡ßã‡•§</p>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="ct">üîå Current Status</div>
    <div style="font-size:13px;line-height:2.4;">
      <div>YouTube: <span id="st-yt"><span class="status-dot dot-r"></span>Not connected</span></div>
      <div>Gemini Key: <span id="st-gk"><span class="status-dot dot-r"></span>Not set</span></div>
      <div>Server Client ID: <span id="st-cid"><span class="status-dot dot-y"></span>Checking...</span></div>
      <div>Redirect URI: <span id="st-uri" style="font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--m);">...</span></div>
    </div>
    <div style="margin-top:14px;display:flex;gap:8px;">
      <button class="btn btn-b btn-sm" id="st-ytbtn" onclick="ytAction()">Connect YouTube</button>
    </div>
  </div>
</div>

</main>

<!-- UPLOAD MODAL -->
<div class="ov" id="umod">
  <div class="modal">
    <h3>üöÄ YouTube ‡¶è Upload ‡¶ï‡¶∞‡ßã</h3>
    <input type="hidden" id="mjid">
    <div class="fg"><label class="fl">Title</label><input type="text" id="mti" placeholder="Short title..."></div>
    <div class="fg"><label class="fl">Caption / Description</label><textarea id="mca" placeholder="#shorts #viral ..."></textarea></div>
    <div class="fg"><label class="fl">Tags (‡¶ï‡¶Æ‡¶æ ‡¶¶‡¶ø‡¶Ø‡¶º‡ßá)</label><input type="text" id="mta" placeholder="shorts, viral, trending"></div>
    <div class="fg"><label class="fl">Privacy</label>
      <select id="mpr">
        <option value="public">Public</option>
        <option value="unlisted">Unlisted</option>
        <option value="private">Private</option>
      </select>
    </div>
    <div class="mbtns">
      <button class="btn btn-g" onclick="uploadNow()">üöÄ ‡¶è‡¶ñ‡¶®‡¶á Upload</button>
    </div>
    <div style="margin-top:14px;padding-top:14px;border-top:1px solid var(--br);">
      <label class="fl">üìÖ Schedule ‡¶ï‡¶∞‡ßã</label>
      <div style="display:flex;gap:8px;margin-top:5px;flex-wrap:wrap;">
        <input type="datetime-local" id="mst" style="flex:1;min-width:180px;">
        <button class="btn btn-b btn-sm" onclick="doSchedule()">Schedule</button>
      </div>
    </div>
    <button class="btn btn-gh btn-sm" onclick="closeM()" style="margin-top:10px;width:100%;justify-content:center;">Cancel</button>
  </div>
</div>

<script>
// ‚îÄ‚îÄ STATE ‚îÄ‚îÄ
let isAuth = false;
let analyzeJobId = null;
let currentUrl = null;
let currentClips = [];
let clipJobs = {};
let pollT = null;
let aPollT = null;

// ‚îÄ‚îÄ INIT ‚îÄ‚îÄ
window.addEventListener('DOMContentLoaded', async () => {
  // Load saved Gemini key
  const gk = localStorage.getItem('gk');
  if (gk) {
    hideBanner();
    updateKeyStatus(true);
    // Sync to session
    fetch('/save_gemini_key', {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({key: gk})
    });
  }

  // Load server status
  try {
    const d = await fetch('/check').then(r => r.json());
    isAuth = d.authenticated || false;
    updateYTBadge(isAuth);

    // Update settings status
    document.getElementById('st-cid').innerHTML = d.client_id_set
      ? '<span class="status-dot dot-g"></span>Set ‚úÖ'
      : '<span class="status-dot dot-r"></span>Missing ‚ùå';

    const uri = d.redirect_uri || '';
    document.getElementById('ruri').textContent = uri;
    document.getElementById('st-uri').textContent = uri;

    if (d.gemini_env_set) {
      hideBanner();
      document.getElementById('st-gk').innerHTML = '<span class="status-dot dot-g"></span>Server key set ‚úÖ';
    } else if (gk) {
      document.getElementById('st-gk').innerHTML = '<span class="status-dot dot-g"></span>Browser key set ‚úÖ';
    }

    // Flash messages from URL params
    const params = new URLSearchParams(window.location.search);
    if (params.get('auth_success')) {
      showFlash('‚úÖ YouTube ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶∏‡¶Ç‡¶Ø‡ßÅ‡¶ï‡ßç‡¶§ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá!', 'ok');
      isAuth = true;
      updateYTBadge(true);
      window.history.replaceState({}, '', '/');
    }
    if (params.get('auth_error')) {
      showFlash('‚ùå Auth error: ' + params.get('auth_error'), 'er');
      window.history.replaceState({}, '', '/');
    }
  } catch(e) {
    // Offline/preview mode
    document.getElementById('st-cid').innerHTML = '<span class="status-dot dot-y"></span>Server offline';
  }
});

// ‚îÄ‚îÄ NAV ‚îÄ‚îÄ
function go(p) {
  document.querySelectorAll('.pn').forEach(x => x.classList.remove('on'));
  document.querySelectorAll('.ni').forEach(x => x.classList.remove('on'));
  document.getElementById(`p-${p}`).classList.add('on');
  document.getElementById(`n-${p}`).classList.add('on');
  if (p === 'schedule') loadSchedules();
}

// ‚îÄ‚îÄ HELPERS ‚îÄ‚îÄ
function adj(d) {
  const el = document.getElementById('nc');
  el.value = Math.max(1, Math.min(20, parseInt(el.value || 5) + d));
}
function fmt(s) {
  const m = Math.floor(s / 60), sec = Math.floor(s % 60);
  return `${m}:${sec.toString().padStart(2, '0')}`;
}
function showFlash(msg, type) {
  const a = document.getElementById('flash-area');
  a.innerHTML = `<div class="flash ${type}">${msg}</div>`;
  setTimeout(() => { a.innerHTML = ''; }, 5000);
}
function hideBanner() {
  document.getElementById('gemini-banner').style.display = 'none';
}
function updateKeyStatus(set) {
  const el = document.getElementById('key-status');
  if (el) el.textContent = set ? '‚úÖ Key saved' : '';
  const stEl = document.getElementById('st-gk');
  if (stEl) stEl.innerHTML = set
    ? '<span class="status-dot dot-g"></span>Browser key set ‚úÖ'
    : '<span class="status-dot dot-r"></span>Not set';
}
function updateYTBadge(connected) {
  const badge = document.getElementById('yt-badge');
  const txt = document.getElementById('yt-txt');
  const btn = document.getElementById('yt-btn');
  const stBtn = document.getElementById('st-ytbtn');
  const stYt = document.getElementById('st-yt');

  if (connected) {
    badge.className = 'yt-badge ok';
    if (txt) txt.textContent = 'Connected';
    badge.firstElementChild.textContent = '‚úÖ';
    btn.textContent = 'Disconnect';
    btn.className = 'sb disc';
    if (stBtn) { stBtn.textContent = 'Disconnect'; stBtn.className = 'btn btn-gh btn-sm'; }
    if (stYt) stYt.innerHTML = '<span class="status-dot dot-g"></span>Connected ‚úÖ';
  } else {
    badge.className = 'yt-badge no';
    if (txt) txt.textContent = 'Not connected';
    badge.firstElementChild.textContent = '‚ö†Ô∏è';
    btn.textContent = 'Connect YouTube';
    btn.className = 'sb conn';
    if (stBtn) { stBtn.textContent = 'Connect YouTube'; stBtn.className = 'btn btn-b btn-sm'; }
    if (stYt) stYt.innerHTML = '<span class="status-dot dot-r"></span>Not connected';
  }
}
function copyURI() {
  const t = document.getElementById('ruri').textContent;
  navigator.clipboard.writeText(t).then(() => alert('‚úÖ URI Copied!'));
}

// ‚îÄ‚îÄ GEMINI KEY ‚îÄ‚îÄ
function saveGeminiKey() {
  const k = document.getElementById('sk')?.value.trim()
         || document.getElementById('quick-gk')?.value.trim() || '';
  if (!k) { alert('Key ‡¶¶‡¶æ‡¶ì!'); return; }
  localStorage.setItem('gk', k);
  hideBanner();
  updateKeyStatus(true);
  fetch('/save_gemini_key', {
    method: 'POST', headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({key: k})
  });
  showFlash('‚úÖ Gemini key saved!', 'ok');
}

// ‚îÄ‚îÄ YOUTUBE AUTH ‚îÄ‚îÄ
async function ytAction() {
  if (isAuth) {
    location.href = '/logout';
    return;
  }
  try {
    const r = await fetch('/get_auth_url');
    const d = await r.json();
    if (d.error) { showFlash('‚ùå ' + d.error + ' ‚Äî Setup tab ‡¶¶‡ßá‡¶ñ‡ßã‡•§', 'er'); return; }
    window.open(d.url, '_blank');
    showFlash('üîó Browser ‡¶è Google login ‡¶ï‡¶∞‡ßã, ‡¶§‡¶æ‡¶∞‡¶™‡¶∞ ‡¶è‡¶á page ‡¶ü‡¶æ refresh ‡¶ï‡¶∞‡ßã‡•§', 'ok');
  } catch(e) {
    showFlash('‚ùå Server ‡¶è‡¶∞ ‡¶∏‡¶æ‡¶•‡ßá connect ‡¶π‡¶ö‡ßç‡¶õ‡ßá ‡¶®‡¶æ‡•§', 'er');
  }
}

// ‚îÄ‚îÄ ANALYZE ‚îÄ‚îÄ
async function doAnalyze() {
  const url = document.getElementById('vu').value.trim();
  const nc = parseInt(document.getElementById('nc').value) || 5;
  const gk = localStorage.getItem('gk') || '';

  if (!url) { showFlash('‚ö†Ô∏è YouTube URL ‡¶¶‡¶æ‡¶ì‡•§', 'er'); return; }
  if (!gk) {
    showFlash('‚ö†Ô∏è Gemini API key ‡¶¶‡¶æ‡¶ì! ‡¶â‡¶™‡¶∞‡ßá‡¶∞ box ‡¶è‡•§', 'er');
    document.getElementById('gemini-banner').style.display = 'flex';
    return;
  }

  currentUrl = url;
  currentClips = [];
  clipJobs = {};

  document.getElementById('abtn').disabled = true;
  document.getElementById('aprog').style.display = 'block';
  document.getElementById('tsx').style.display = 'none';
  document.getElementById('msx').style.display = 'none';
  document.getElementById('csx').style.display = 'none';
  document.getElementById('abar').style.width = '0%';
  document.getElementById('ast').textContent = '‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶π‡¶ö‡ßç‡¶õ‡ßá...';

  try {
    const r = await fetch('/analyze', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({url, num_clips: nc, gemini_key: gk})
    });
    const d = await r.json();
    if (d.error) {
      showFlash('‚ùå ' + d.error, 'er');
      document.getElementById('abtn').disabled = false;
      document.getElementById('aprog').style.display = 'none';
      return;
    }
    analyzeJobId = d.job_id;
    if (aPollT) clearInterval(aPollT);
    aPollT = setInterval(pollAnalyze, 2000);
  } catch(e) {
    showFlash('‚ùå Network error.', 'er');
    document.getElementById('abtn').disabled = false;
  }
}

async function pollAnalyze() {
  if (!analyzeJobId) return;
  try {
    const d = await fetch(`/status/${analyzeJobId}`).then(r => r.json());
    document.getElementById('ast').textContent = d.status || '';
    if (d.progress) document.getElementById('abar').style.width = d.progress + '%';

    if (d.status === 'Done') {
      clearInterval(aPollT);
      document.getElementById('abtn').disabled = false;
      document.getElementById('aprog').style.display = 'none';

      if (d.transcript) {
        document.getElementById('tsx').style.display = 'block';
        document.getElementById('txtext').textContent = d.transcript;
      }
      if (d.clips?.length) {
        currentClips = d.clips;
        showMoments(d.clips);
      }
    } else if (d.status?.startsWith('Error')) {
      clearInterval(aPollT);
      document.getElementById('abtn').disabled = false;
      showFlash('‚ùå ' + d.status, 'er');
      document.getElementById('aprog').style.display = 'none';
    }
  } catch(e) {}
}

function showMoments(clips) {
  document.getElementById('msx').style.display = 'block';
  document.getElementById('mgrid').innerHTML = clips.map((c, i) => `
    <div class="mc" onclick="genOne(${i})">
      <div class="mc-time">‚è± ${fmt(c.start)} ‚Üí ${fmt(c.end)} ¬∑ ${c.duration}s</div>
      <div class="mc-title">${c.title}</div>
      <div class="mc-reason">${c.reason}</div>
      ${c.hook ? `<div class="mc-hook">üé£ ${c.hook}</div>` : ''}
    </div>
  `).join('');
}

// ‚îÄ‚îÄ GENERATE ‚îÄ‚îÄ
async function genAll() {
  if (!currentClips.length || !currentUrl) return;
  document.getElementById('gab').disabled = true;
  document.getElementById('csx').style.display = 'block';

  try {
    const r = await fetch('/generate_all_clips', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({url: currentUrl, clips: currentClips})
    });
    const d = await r.json();
    if (d.error) { showFlash('‚ùå ' + d.error, 'er'); document.getElementById('gab').disabled = false; return; }

    d.job_ids.forEach((jid, i) => {
      clipJobs[jid] = currentClips[i];
      appendClipCard(jid, currentClips[i]);
    });
    startClipPoll();
  } catch(e) {
    showFlash('‚ùå Network error.', 'er');
    document.getElementById('gab').disabled = false;
  }
}

async function genOne(idx) {
  const clip = currentClips[idx];
  document.getElementById('csx').style.display = 'block';

  try {
    const r = await fetch('/generate_single_clip', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({url: currentUrl, start: clip.start, end: clip.end, title: clip.title})
    });
    const d = await r.json();
    clipJobs[d.job_id] = clip;
    appendClipCard(d.job_id, clip);
    startClipPoll();
  } catch(e) {
    showFlash('‚ùå Network error.', 'er');
  }
}

function appendClipCard(jid, clip) {
  const grid = document.getElementById('cgrid');
  const div = document.createElement('div');
  div.className = 'cc';
  div.id = `cc-${jid}`;
  div.innerHTML = `
    <div class="cthumb" id="ct-${jid}"><span class="ep">‚è≥</span></div>
    <div class="cinfo">
      <div class="ctime">‚è± ${fmt(clip.start)} ‚Üí ${fmt(clip.end)}</div>
      <div class="ctitle">${clip.title}</div>
      <div class="creason">${clip.reason || ''}</div>
      <div class="cst" id="cs-${jid}">Processing...</div>
      <div class="cact" id="ca-${jid}"></div>
    </div>`;
  grid.appendChild(div);
}

function startClipPoll() {
  if (pollT) clearInterval(pollT);
  pollT = setInterval(pollClips, 2500);
}

async function pollClips() {
  const active = Object.keys(clipJobs).filter(jid => !document.getElementById(`cc-${jid}`)?.dataset.done);
  if (!active.length) {
    clearInterval(pollT);
    document.getElementById('gab').disabled = false;
    return;
  }
  try {
    const d = await fetch('/status_batch', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({job_ids: active})
    }).then(r => r.json());
    active.forEach(jid => updateClipCard(jid, d[jid]));
  } catch(e) {}
}

function updateClipCard(jid, d) {
  if (!d) return;
  const card = document.getElementById(`cc-${jid}`);
  const st = document.getElementById(`cs-${jid}`);
  const act = document.getElementById(`ca-${jid}`);
  const thumb = document.getElementById(`ct-${jid}`);
  if (!card) return;

  if (st) {
    st.textContent = d.status || '';
    st.className = 'cst';
    if (d.crop_ready) st.classList.add('ok');
    if (d.status?.startsWith('Error')) st.classList.add('er');
  }

  if (d.crop_ready && !card.dataset.showed) {
    card.dataset.showed = '1';
    if (thumb) thumb.innerHTML = `<video src="/preview/${jid}" preload="metadata" muted playsinline style="width:100%;height:120px;object-fit:cover;"></video>`;
    if (act) act.innerHTML = `<button class="btn btn-g btn-sm" onclick="openModal('${jid}')">üöÄ Upload</button>`;
  }

  if (d.status === 'Done! ‚úÖ' && d.result_url) {
    card.dataset.done = '1';
    if (act) act.innerHTML = '';
    const infoEl = card.querySelector('.cinfo');
    if (infoEl) infoEl.insertAdjacentHTML('beforeend', `<a href="${d.result_url}" target="_blank" class="rlink">üéâ YouTube ‡¶è ‡¶¶‡ßá‡¶ñ‡ßã ‚Üí</a>`);
  }
}

// ‚îÄ‚îÄ UPLOAD MODAL ‚îÄ‚îÄ
function openModal(jid) {
  document.getElementById('mjid').value = jid;
  fetch(`/status/${jid}`).then(r => r.json()).then(d => {
    document.getElementById('mti').value = d.title || '';
    document.getElementById('mca').value = d.caption || '#shorts #viral';
    document.getElementById('mta').value = d.tags || 'shorts, viral';
    document.getElementById('mpr').value = d.privacy || 'public';
  });
  const dt = new Date(Date.now() + 3600000);
  document.getElementById('mst').value = dt.toISOString().slice(0, 16);
  document.getElementById('umod').classList.add('on');
}
function closeM() { document.getElementById('umod').classList.remove('on'); }

async function uploadNow() {
  const jid = document.getElementById('mjid').value;
  const body = getModal();
  closeM();

  try {
    const r = await fetch(`/upload_now/${jid}`, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify(body)
    });
    const d = await r.json();
    if (d.need_auth) {
      window.open(d.auth_url, '_blank');
      showFlash('‚ö†Ô∏è YouTube login ‡¶ï‡¶∞‡ßã ‡¶§‡¶æ‡¶∞‡¶™‡¶∞ ‡¶Ü‡¶¨‡¶æ‡¶∞ ‡¶ö‡ßá‡¶∑‡ßç‡¶ü‡¶æ ‡¶ï‡¶∞‡ßã‡•§', 'er');
      return;
    }
    const st = document.getElementById(`cs-${jid}`);
    if (st) st.textContent = 'Uploading...';
    const act = document.getElementById(`ca-${jid}`);
    if (act) act.innerHTML = '';
    startClipPoll();
  } catch(e) {
    showFlash('‚ùå Network error.', 'er');
  }
}

async function doSchedule() {
  const jid = document.getElementById('mjid').value;
  const t = document.getElementById('mst').value;
  if (!t) { alert('‡¶∏‡¶Æ‡¶Ø‡¶º ‡¶¶‡¶æ‡¶ì!'); return; }
  const body = {...getModal(), job_id: jid, scheduled_time: t};
  try {
    await fetch('/schedule', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify(body)
    });
    closeM();
    showFlash('‚úÖ Schedule ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá! Schedule tab ‡¶è ‡¶¶‡ßá‡¶ñ‡ßã‡•§', 'ok');
  } catch(e) {
    showFlash('‚ùå Network error.', 'er');
  }
}

function getModal() {
  return {
    title: document.getElementById('mti').value,
    caption: document.getElementById('mca').value,
    tags: document.getElementById('mta').value,
    privacy: document.getElementById('mpr').value,
  };
}

// ‚îÄ‚îÄ SCHEDULES ‚îÄ‚îÄ
async function loadSchedules() {
  const sc = document.getElementById('sc');
  try {
    const d = await fetch('/schedules').then(r => r.json());
    if (!d.length) {
      sc.innerHTML = '<div class="se"><div class="sei">üóìÔ∏è</div><p>‡¶ï‡ßã‡¶®‡ßã scheduled upload ‡¶®‡ßá‡¶á<br><small style="color:var(--m);">Clip generate ‡¶ï‡¶∞‡ßá Upload modal ‡¶è Schedule ‡¶ï‡¶∞‡ßã</small></p></div>';
      return;
    }
    let h = '<table><thead><tr><th>Title</th><th>Scheduled</th><th>Privacy</th><th>Status</th><th></th></tr></thead><tbody>';
    d.forEach(s => {
      const dt = s.scheduled_time ? new Date(s.scheduled_time).toLocaleString() : '‚Äî';
      h += `<tr>
        <td>${s.title || s.job_id}</td>
        <td style="font-family:'JetBrains Mono',monospace;font-size:11px;">${dt}</td>
        <td>${s.privacy || 'public'}</td>
        <td><span class="pill ${s.status}">${s.status}</span></td>
        <td><button class="btn btn-gh btn-sm" onclick="delSched('${s.id}')">üóëÔ∏è</button></td>
      </tr>`;
    });
    sc.innerHTML = h + '</tbody></table>';
  } catch(e) {
    sc.innerHTML = '<div class="se"><div class="sei">‚ö†Ô∏è</div><p>Server connect ‡¶π‡¶ö‡ßç‡¶õ‡ßá ‡¶®‡¶æ</p></div>';
  }
}

async function delSched(id) {
  if (!confirm('‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶¨‡ßã?')) return;
  await fetch(`/schedule/${id}`, {method: 'DELETE'});
  loadSchedules();
}
</script>
</body>
</html>

